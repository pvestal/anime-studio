name: Anime Production CI/CD Pipeline

on:
  push:
    branches: [ main, development, feature/* ]
  pull_request:
    branches: [ main, development ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  NODE_VERSION: "18"

jobs:
  code-quality:
    name: Code Quality & Security
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint black isort bandit safety

    - name: Code formatting check
      run: |
        black --check --diff .
        isort --check-only --diff .

    - name: Lint code
      run: |
        pylint *.py --disable=C0114,C0115,C0116 --max-line-length=100

    - name: Security scan
      run: |
        bandit -r . -f json -o security-report.json
        safety check --json --output safety-report.json

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          security-report.json
          safety-report.json

  database-tests:
    name: Database Migration Testing
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production'
    needs: code-quality

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: anime_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio

    - name: Create test database schema
      run: |
        python -c "
        import psycopg2
        conn = psycopg2.connect(
            host='localhost',
            database='anime_test',
            user='test_user',
            password='test_password'
        )
        cur = conn.cursor()
        # Create basic test schema
        cur.execute('''
        CREATE TABLE IF NOT EXISTS projects (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            status VARCHAR(50) DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT NOW(),
            updated_at TIMESTAMP DEFAULT NOW(),
            metadata JSONB,
            generation_start_time TIMESTAMP,
            retry_count INTEGER DEFAULT 0,
            output_path TEXT,
            quality_score FLOAT,
            completion_metadata TEXT,
            failure_reason TEXT
        );
        ''')
        conn.commit()
        conn.close()
        "

    - name: Run database migration tests
      run: |
        python -m pytest tests/test_database_migrations.py -v

    - name: Test database performance
      run: |
        python -c "
        import psycopg2
        import time

        conn = psycopg2.connect(
            host='localhost',
            database='anime_test',
            user='test_user',
            password='test_password'
        )
        cur = conn.cursor()

        # Test bulk insert performance
        start = time.time()
        for i in range(1000):
            cur.execute(
                'INSERT INTO projects (name, description) VALUES (%s, %s)',
                (f'Test Project {i}', f'Test description {i}')
            )
        conn.commit()
        duration = time.time() - start
        print(f'Bulk insert of 1000 records: {duration:.2f}s')

        # Test query performance
        start = time.time()
        cur.execute('SELECT COUNT(*) FROM projects WHERE status = %s', ('pending',))
        result = cur.fetchone()
        duration = time.time() - start
        print(f'Count query: {duration:.4f}s, Result: {result[0]}')

        conn.close()
        "

  unit-tests:
    name: Unit Tests
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production'
    needs: code-quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov

    - name: Run unit tests
      run: |
        pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html

    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/

  integration-tests:
    name: Service Integration Tests
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production'
    needs: [unit-tests, database-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx

    - name: Check service dependencies
      run: |
        # Check if ComfyUI is accessible
        curl -f http://192.168.50.135:8188/history || echo "ComfyUI not available for testing"

        # Check if Echo Brain is accessible
        curl -k -f https://192.168.50.135/api/echo/health || echo "Echo Brain not available for testing"

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --tb=short

    - name: Test service communication
      run: |
        python -c "
        import asyncio
        import httpx
        import json

        async def test_service_communication():
            # Test anime API health
            async with httpx.AsyncClient(timeout=10.0) as client:
                try:
                    response = await client.get('http://127.0.0.1:8328/api/health')
                    print(f'Anime API health: {response.status_code}')
                except Exception as e:
                    print(f'Anime API not accessible: {e}')

                # Test Echo Brain integration
                try:
                    response = await client.get('https://192.168.50.135/api/echo/health', verify=False)
                    print(f'Echo Brain health: {response.status_code}')
                except Exception as e:
                    print(f'Echo Brain not accessible: {e}')

        asyncio.run(test_service_communication())
        "

  performance-tests:
    name: Performance & Load Testing
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production' && github.ref == 'refs/heads/main'
    needs: integration-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust

    - name: Run performance tests
      run: |
        # API endpoint performance test
        python -c "
        import time
        import asyncio
        import httpx

        async def performance_test():
            async with httpx.AsyncClient(timeout=30.0) as client:
                # Test health endpoint performance
                times = []
                for i in range(10):
                    start = time.time()
                    try:
                        response = await client.get('http://127.0.0.1:8328/api/health')
                        times.append(time.time() - start)
                        print(f'Request {i+1}: {times[-1]:.3f}s')
                    except Exception as e:
                        print(f'Request {i+1} failed: {e}')

                if times:
                    avg_time = sum(times) / len(times)
                    print(f'Average response time: {avg_time:.3f}s')
                    print(f'Max response time: {max(times):.3f}s')
                    print(f'Min response time: {min(times):.3f}s')

                    # Fail if average response time > 2 seconds
                    if avg_time > 2.0:
                        print('‚ùå Performance test failed: Response time too slow')
                        exit(1)
                    else:
                        print('‚úÖ Performance test passed')

        asyncio.run(performance_test())
        "

  security-scan:
    name: Security Vulnerability Scan
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production'
    needs: code-quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit semgrep safety pip-audit

    - name: Run security scans
      run: |
        echo "üîí Running security scans..."

        # Bandit for common security issues
        bandit -r . -f json -o bandit-report.json || true

        # Safety for known vulnerabilities
        safety check --json --output safety-report.json || true

        # Pip-audit for dependency vulnerabilities
        pip-audit --format=json --output=pip-audit-report.json || true

        echo "üîç Scanning for hardcoded secrets..."
        grep -r -i "password\|secret\|key\|token" . \
          --exclude-dir=.git \
          --exclude-dir=venv \
          --exclude-dir=logs \
          --exclude="*.json" \
          --exclude="*.yml" \
          --exclude="*.yaml" || true

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-scan-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json

  build-and-deploy:
    name: Build and Deploy
    runs-on: self-hosted
    if: github.repository == 'pvestal/anime-production' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development')
    needs: [integration-tests, performance-tests, security-scan]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set deployment target
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "DEPLOY_ENV=production" >> $GITHUB_ENV
          echo "SERVICE_PORT=8328" >> $GITHUB_ENV
        else
          echo "DEPLOY_ENV=staging" >> $GITHUB_ENV
          echo "SERVICE_PORT=8329" >> $GITHUB_ENV
        fi

    - name: Create deployment backup
      run: |
        BACKUP_DIR="/opt/anime-backups/$(date +%Y%m%d_%H%M%S)"
        sudo mkdir -p "$BACKUP_DIR"
        sudo cp -r /opt/tower-anime-production "$BACKUP_DIR/pre-deploy"
        echo "BACKUP_PATH=$BACKUP_DIR" >> $GITHUB_ENV

    - name: Deploy to target environment
      run: |
        echo "üöÄ Deploying to ${{ env.DEPLOY_ENV }} environment"

        # Stop service for deployment
        sudo systemctl stop tower-anime-production

        # Update code
        sudo cp -r . /opt/tower-anime-production-new
        sudo rm -rf /opt/tower-anime-production-old || true
        sudo mv /opt/tower-anime-production /opt/tower-anime-production-old
        sudo mv /opt/tower-anime-production-new /opt/tower-anime-production

        # Update permissions
        sudo chown -R patrick:patrick /opt/tower-anime-production

        # Install/update dependencies
        cd /opt/tower-anime-production
        source venv/bin/activate
        pip install -r requirements.txt

        # Start service
        sudo systemctl start tower-anime-production

        # Wait for service to be ready
        sleep 10

    - name: Health check after deployment
      run: |
        echo "üè• Checking service health after deployment..."

        # Check if service is running
        if ! sudo systemctl is-active --quiet tower-anime-production; then
          echo "‚ùå Service failed to start"
          exit 1
        fi

        # Check API endpoint
        for i in {1..30}; do
          if curl -f http://127.0.0.1:${{ env.SERVICE_PORT }}/api/health; then
            echo "‚úÖ Service is healthy"
            break
          else
            echo "‚è≥ Waiting for service to be ready... ($i/30)"
            sleep 2
          fi
        done

        # Final health check
        curl -f http://127.0.0.1:${{ env.SERVICE_PORT }}/api/health || {
          echo "‚ùå Health check failed after deployment"
          exit 1
        }

    - name: Rollback on failure
      if: failure()
      run: |
        echo "üîÑ Rolling back deployment due to failure"

        sudo systemctl stop tower-anime-production
        sudo rm -rf /opt/tower-anime-production || true
        sudo mv /opt/tower-anime-production-old /opt/tower-anime-production
        sudo systemctl start tower-anime-production

        # Wait and verify rollback
        sleep 10
        curl -f http://127.0.0.1:${{ env.SERVICE_PORT }}/api/health || {
          echo "‚ùå Rollback failed - manual intervention required"
          exit 1
        }
        echo "‚úÖ Rollback completed successfully"

    - name: Cleanup old backups
      if: success()
      run: |
        # Keep only last 5 backups
        sudo find /opt/anime-backups -type d -name "20*" | sort -r | tail -n +6 | sudo xargs rm -rf || true
        sudo rm -rf /opt/tower-anime-production-old || true

    - name: Notify deployment success
      if: success()
      run: |
        echo "üéâ Deployment to ${{ env.DEPLOY_ENV }} completed successfully"

        # Log deployment
        echo "$(date): Deployed commit ${{ github.sha }} to ${{ env.DEPLOY_ENV }}" >> /opt/tower-anime-production/logs/deployment.log

  notify:
    name: Notification
    runs-on: self-hosted
    if: always() && github.repository == 'pvestal/anime-production'
    needs: [build-and-deploy]

    steps:
    - name: Send notification
      run: |
        STATUS="${{ job.status }}"
        if [[ "$STATUS" == "success" ]]; then
          EMOJI="‚úÖ"
          STATUS_MSG="SUCCESS"
        else
          EMOJI="‚ùå"
          STATUS_MSG="FAILED"
        fi

        MESSAGE="$EMOJI Anime Production CI/CD Pipeline $STATUS_MSG

        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Actor: ${{ github.actor }}
        Workflow: ${{ github.workflow }}

        View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        echo "$MESSAGE"

        # Send to Echo Brain for logging
        curl -k -X POST "https://192.168.50.135/api/echo/query" \
          -H "Content-Type: application/json" \
          -d "{
            \"query\": \"Log CI/CD pipeline result: $MESSAGE\",
            \"conversation_id\": \"cicd_notifications\",
            \"metadata\": {
              \"type\": \"cicd_notification\",
              \"status\": \"$STATUS\",
              \"repository\": \"${{ github.repository }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"commit\": \"${{ github.sha }}\"
            }
          }" || echo "Failed to notify Echo Brain"